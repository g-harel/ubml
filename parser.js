// minified xml parser and html formatter
function SAXParser(a,b){if(!(this instanceof SAXParser))return new SAXParser(a,b);var c=this;clearBuffers(c),c.q=c.c="",c.bufferCheckPosition=sax.MAX_BUFFER_LENGTH,c.opt=b||{},c.opt.lowercase=c.opt.lowercase||c.opt.lowercasetags,c.looseCase=c.opt.lowercase?"toLowerCase":"toUpperCase",c.tags=[],c.closed=c.closedRoot=c.sawRoot=!1,c.tag=c.error=null,c.strict=!!a,c.noscript=!(!a&&!c.opt.noscript),c.state=S.BEGIN,c.strictEntities=c.opt.strictEntities,c.ENTITIES=c.strictEntities?Object.create(sax.XML_ENTITIES):Object.create(sax.ENTITIES),c.attribList=[],c.opt.xmlns&&(c.ns=Object.create(rootNS)),c.trackPosition=c.opt.position!==!1,c.trackPosition&&(c.position=c.line=c.column=0),emit(c,"onready")}function checkBufferLength(a){for(var b=Math.max(sax.MAX_BUFFER_LENGTH,10),c=0,d=0,e=buffers.length;d<e;d++){var f=a[buffers[d]].length;if(f>b)switch(buffers[d]){case"textNode":closeText(a);break;case"cdata":emitNode(a,"oncdata",a.cdata),a.cdata="";break;case"script":emitNode(a,"onscript",a.script),a.script="";break;default:error(a,"Max buffer length exceeded: "+buffers[d])}c=Math.max(c,f)}var g=sax.MAX_BUFFER_LENGTH-c;a.bufferCheckPosition=g+a.position}function clearBuffers(a){for(var b=0,c=buffers.length;b<c;b++)a[buffers[b]]=""}function flushBuffers(a){closeText(a),""!==a.cdata&&(emitNode(a,"oncdata",a.cdata),a.cdata=""),""!==a.script&&(emitNode(a,"onscript",a.script),a.script="")}function createStream(a,b){return new SAXStream(a,b)}function SAXStream(a,b){if(!(this instanceof SAXStream))return new SAXStream(a,b);Stream.apply(this),this._parser=new SAXParser(a,b),this.writable=!0,this.readable=!0;var c=this;this._parser.onend=function(){c.emit("end")},this._parser.onerror=function(a){c.emit("error",a),c._parser.error=null},this._decoder=null,streamWraps.forEach(function(a){Object.defineProperty(c,"on"+a,{get:function(){return c._parser["on"+a]},set:function(b){return b?void c.on(a,b):(c.removeAllListeners(a),c._parser["on"+a]=b,b)},enumerable:!0,configurable:!1})})}function charClass(a){return a.split("").reduce(function(a,b){return a[b]=!0,a},{})}function isRegExp(a){return"[object RegExp]"===Object.prototype.toString.call(a)}function is(a,b){return isRegExp(a)?!!b.match(a):a[b]}function not(a,b){return!is(a,b)}function emit(a,b,c){a[b]&&a[b](c)}function emitNode(a,b,c){a.textNode&&closeText(a),emit(a,b,c)}function closeText(a){a.textNode=textopts(a.opt,a.textNode),a.textNode&&emit(a,"ontext",a.textNode),a.textNode=""}function textopts(a,b){return a.trim&&(b=b.trim()),a.normalize&&(b=b.replace(/\s+/g," ")),b}function error(a,b){return closeText(a),a.trackPosition&&(b+="\nLine: "+a.line+"\nColumn: "+a.column+"\nChar: "+a.c),b=new Error(b),a.error=b,emit(a,"onerror",b),a}function end(a){return a.sawRoot&&!a.closedRoot&&strictFail(a,"Unclosed root tag"),a.state!==S.BEGIN&&a.state!==S.BEGIN_WHITESPACE&&a.state!==S.TEXT&&error(a,"Unexpected end"),closeText(a),a.c="",a.closed=!0,emit(a,"onend"),SAXParser.call(a,a.strict,a.opt),a}function strictFail(a,b){if("object"!=typeof a||!(a instanceof SAXParser))throw new Error("bad call to strictFail");a.strict&&error(a,b)}function newTag(a){a.strict||(a.tagName=a.tagName[a.looseCase]());var b=a.tags[a.tags.length-1]||a,c=a.tag={name:a.tagName,attributes:{}};a.opt.xmlns&&(c.ns=b.ns),a.attribList.length=0,emitNode(a,"onopentagstart",c)}function qname(a,b){var c=a.indexOf(":"),d=c<0?["",a]:a.split(":"),e=d[0],f=d[1];return b&&"xmlns"===a&&(e="xmlns",f=""),{prefix:e,local:f}}function attrib(a){if(a.strict||(a.attribName=a.attribName[a.looseCase]()),a.attribList.indexOf(a.attribName)!==-1||a.tag.attributes.hasOwnProperty(a.attribName))return void(a.attribName=a.attribValue="");if(a.opt.xmlns){var b=qname(a.attribName,!0),c=b.prefix,d=b.local;if("xmlns"===c)if("xml"===d&&a.attribValue!==XML_NAMESPACE)strictFail(a,"xml: prefix must be bound to "+XML_NAMESPACE+"\nActual: "+a.attribValue);else if("xmlns"===d&&a.attribValue!==XMLNS_NAMESPACE)strictFail(a,"xmlns: prefix must be bound to "+XMLNS_NAMESPACE+"\nActual: "+a.attribValue);else{var e=a.tag,f=a.tags[a.tags.length-1]||a;e.ns===f.ns&&(e.ns=Object.create(f.ns)),e.ns[d]=a.attribValue}a.attribList.push([a.attribName,a.attribValue])}else a.tag.attributes[a.attribName]=a.attribValue,emitNode(a,"onattribute",{name:a.attribName,value:a.attribValue});a.attribName=a.attribValue=""}function openTag(a,b){if(a.opt.xmlns){var c=a.tag,d=qname(a.tagName);c.prefix=d.prefix,c.local=d.local,c.uri=c.ns[d.prefix]||"",c.prefix&&!c.uri&&(strictFail(a,"Unbound namespace prefix: "+JSON.stringify(a.tagName)),c.uri=d.prefix);var e=a.tags[a.tags.length-1]||a;c.ns&&e.ns!==c.ns&&Object.keys(c.ns).forEach(function(b){emitNode(a,"onopennamespace",{prefix:b,uri:c.ns[b]})});for(var f=0,g=a.attribList.length;f<g;f++){var h=a.attribList[f],i=h[0],j=h[1],k=qname(i,!0),l=k.prefix,m=k.local,n=""===l?"":c.ns[l]||"",o={name:i,value:j,prefix:l,local:m,uri:n};l&&"xmlns"!==l&&!n&&(strictFail(a,"Unbound namespace prefix: "+JSON.stringify(l)),o.uri=l),a.tag.attributes[i]=o,emitNode(a,"onattribute",o)}a.attribList.length=0}a.tag.isSelfClosing=!!b,a.sawRoot=!0,a.tags.push(a.tag),emitNode(a,"onopentag",a.tag),b||(a.noscript||"script"!==a.tagName.toLowerCase()?a.state=S.TEXT:a.state=S.SCRIPT,a.tag=null,a.tagName=""),a.attribName=a.attribValue="",a.attribList.length=0}function closeTag(a){if(!a.tagName)return strictFail(a,"Weird empty close tag."),a.textNode+="</>",void(a.state=S.TEXT);if(a.script){if("script"!==a.tagName)return a.script+="</"+a.tagName+">",a.tagName="",void(a.state=S.SCRIPT);emitNode(a,"onscript",a.script),a.script=""}var b=a.tags.length,c=a.tagName;a.strict||(c=c[a.looseCase]());for(var d=c;b--;){var e=a.tags[b];if(e.name===d)break;strictFail(a,"Unexpected close tag")}if(b<0)return strictFail(a,"Unmatched closing tag: "+a.tagName),a.textNode+="</"+a.tagName+">",void(a.state=S.TEXT);a.tagName=c;for(var f=a.tags.length;f-- >b;){var g=a.tag=a.tags.pop();a.tagName=a.tag.name,emitNode(a,"onclosetag",a.tagName);var h={};for(var i in g.ns)h[i]=g.ns[i];var j=a.tags[a.tags.length-1]||a;a.opt.xmlns&&g.ns!==j.ns&&Object.keys(g.ns).forEach(function(b){var c=g.ns[b];emitNode(a,"onclosenamespace",{prefix:b,uri:c})})}0===b&&(a.closedRoot=!0),a.tagName=a.attribValue=a.attribName="",a.attribList.length=0,a.state=S.TEXT}function parseEntity(a){var d,b=a.entity,c=b.toLowerCase(),e="";return a.ENTITIES[b]?a.ENTITIES[b]:a.ENTITIES[c]?a.ENTITIES[c]:(b=c,"#"===b.charAt(0)&&("x"===b.charAt(1)?(b=b.slice(2),d=parseInt(b,16),e=d.toString(16)):(b=b.slice(1),d=parseInt(b,10),e=d.toString(10))),b=b.replace(/^0+/,""),e.toLowerCase()!==b?(strictFail(a,"Invalid character entity"),"&"+a.entity+";"):String.fromCodePoint(d))}function beginWhiteSpace(a,b){"<"===b?(a.state=S.OPEN_WAKA,a.startTagPosition=a.position):not(whitespace,b)&&(strictFail(a,"Non-whitespace before first tag."),a.textNode=b,a.state=S.TEXT)}function charAt(a,b){var c="";return b<a.length&&(c=a.charAt(b)),c}function write(a){var b=this;if(this.error)throw this.error;if(b.closed)return error(b,"Cannot write after close. Assign an onready handler.");if(null===a)return end(b);"object"==typeof a&&(a=a.toString());for(var c=0,d="";;){if(d=charAt(a,c++),b.c=d,!d)break;switch(b.trackPosition&&(b.position++,"\n"===d?(b.line++,b.column=0):b.column++),b.state){case S.BEGIN:if(b.state=S.BEGIN_WHITESPACE,"\ufeff"===d)continue;beginWhiteSpace(b,d);continue;case S.BEGIN_WHITESPACE:beginWhiteSpace(b,d);continue;case S.TEXT:if(b.sawRoot&&!b.closedRoot){for(var e=c-1;d&&"<"!==d&&"&"!==d;)d=charAt(a,c++),d&&b.trackPosition&&(b.position++,"\n"===d?(b.line++,b.column=0):b.column++);b.textNode+=a.substring(e,c-1)}"<"!==d||b.sawRoot&&b.closedRoot&&!b.strict?(!not(whitespace,d)||b.sawRoot&&!b.closedRoot||strictFail(b,"Text data outside of root node."),"&"===d?b.state=S.TEXT_ENTITY:b.textNode+=d):(b.state=S.OPEN_WAKA,b.startTagPosition=b.position);continue;case S.SCRIPT:"<"===d?b.state=S.SCRIPT_ENDING:b.script+=d;continue;case S.SCRIPT_ENDING:"/"===d?b.state=S.CLOSE_TAG:(b.script+="<"+d,b.state=S.SCRIPT);continue;case S.OPEN_WAKA:if("!"===d)b.state=S.SGML_DECL,b.sgmlDecl="";else if(is(whitespace,d));else if(is(nameStart,d))b.state=S.OPEN_TAG,b.tagName=d;else if("/"===d)b.state=S.CLOSE_TAG,b.tagName="";else if("?"===d)b.state=S.PROC_INST,b.procInstName=b.procInstBody="";else{if(strictFail(b,"Unencoded <"),b.startTagPosition+1<b.position){var f=b.position-b.startTagPosition;d=new Array(f).join(" ")+d}b.textNode+="<"+d,b.state=S.TEXT}continue;case S.SGML_DECL:(b.sgmlDecl+d).toUpperCase()===CDATA?(emitNode(b,"onopencdata"),b.state=S.CDATA,b.sgmlDecl="",b.cdata=""):b.sgmlDecl+d==="--"?(b.state=S.COMMENT,b.comment="",b.sgmlDecl=""):(b.sgmlDecl+d).toUpperCase()===DOCTYPE?(b.state=S.DOCTYPE,(b.doctype||b.sawRoot)&&strictFail(b,"Inappropriately located doctype declaration"),b.doctype="",b.sgmlDecl=""):">"===d?(emitNode(b,"onsgmldeclaration",b.sgmlDecl),b.sgmlDecl="",b.state=S.TEXT):is(quote,d)?(b.state=S.SGML_DECL_QUOTED,b.sgmlDecl+=d):b.sgmlDecl+=d;continue;case S.SGML_DECL_QUOTED:d===b.q&&(b.state=S.SGML_DECL,b.q=""),b.sgmlDecl+=d;continue;case S.DOCTYPE:">"===d?(b.state=S.TEXT,emitNode(b,"ondoctype",b.doctype),b.doctype=!0):(b.doctype+=d,"["===d?b.state=S.DOCTYPE_DTD:is(quote,d)&&(b.state=S.DOCTYPE_QUOTED,b.q=d));continue;case S.DOCTYPE_QUOTED:b.doctype+=d,d===b.q&&(b.q="",b.state=S.DOCTYPE);continue;case S.DOCTYPE_DTD:b.doctype+=d,"]"===d?b.state=S.DOCTYPE:is(quote,d)&&(b.state=S.DOCTYPE_DTD_QUOTED,b.q=d);continue;case S.DOCTYPE_DTD_QUOTED:b.doctype+=d,d===b.q&&(b.state=S.DOCTYPE_DTD,b.q="");continue;case S.COMMENT:"-"===d?b.state=S.COMMENT_ENDING:b.comment+=d;continue;case S.COMMENT_ENDING:"-"===d?(b.state=S.COMMENT_ENDED,b.comment=textopts(b.opt,b.comment),b.comment&&emitNode(b,"oncomment",b.comment),b.comment=""):(b.comment+="-"+d,b.state=S.COMMENT);continue;case S.COMMENT_ENDED:">"!==d?(strictFail(b,"Malformed comment"),b.comment+="--"+d,b.state=S.COMMENT):b.state=S.TEXT;continue;case S.CDATA:"]"===d?b.state=S.CDATA_ENDING:b.cdata+=d;continue;case S.CDATA_ENDING:"]"===d?b.state=S.CDATA_ENDING_2:(b.cdata+="]"+d,b.state=S.CDATA);continue;case S.CDATA_ENDING_2:">"===d?(b.cdata&&emitNode(b,"oncdata",b.cdata),emitNode(b,"onclosecdata"),b.cdata="",b.state=S.TEXT):"]"===d?b.cdata+="]":(b.cdata+="]]"+d,b.state=S.CDATA);continue;case S.PROC_INST:"?"===d?b.state=S.PROC_INST_ENDING:is(whitespace,d)?b.state=S.PROC_INST_BODY:b.procInstName+=d;continue;case S.PROC_INST_BODY:if(!b.procInstBody&&is(whitespace,d))continue;"?"===d?b.state=S.PROC_INST_ENDING:b.procInstBody+=d;continue;case S.PROC_INST_ENDING:">"===d?(emitNode(b,"onprocessinginstruction",{name:b.procInstName,body:b.procInstBody}),b.procInstName=b.procInstBody="",b.state=S.TEXT):(b.procInstBody+="?"+d,b.state=S.PROC_INST_BODY);continue;case S.OPEN_TAG:is(nameBody,d)?b.tagName+=d:(newTag(b),">"===d?openTag(b):"/"===d?b.state=S.OPEN_TAG_SLASH:(not(whitespace,d)&&strictFail(b,"Invalid character in tag name"),b.state=S.ATTRIB));continue;case S.OPEN_TAG_SLASH:">"===d?(openTag(b,!0),closeTag(b)):(strictFail(b,"Forward-slash in opening tag not followed by >"),b.state=S.ATTRIB);continue;case S.ATTRIB:if(is(whitespace,d))continue;">"===d?openTag(b):"/"===d?b.state=S.OPEN_TAG_SLASH:is(nameStart,d)?(b.attribName=d,b.attribValue="",b.state=S.ATTRIB_NAME):strictFail(b,"Invalid attribute name");continue;case S.ATTRIB_NAME:"="===d?b.state=S.ATTRIB_VALUE:">"===d?(strictFail(b,"Attribute without value"),b.attribValue=b.attribName,attrib(b),openTag(b)):is(whitespace,d)?b.state=S.ATTRIB_NAME_SAW_WHITE:is(nameBody,d)?b.attribName+=d:strictFail(b,"Invalid attribute name");continue;case S.ATTRIB_NAME_SAW_WHITE:if("="===d)b.state=S.ATTRIB_VALUE;else{if(is(whitespace,d))continue;strictFail(b,"Attribute without value"),b.tag.attributes[b.attribName]="",b.attribValue="",emitNode(b,"onattribute",{name:b.attribName,value:""}),b.attribName="",">"===d?openTag(b):is(nameStart,d)?(b.attribName=d,b.state=S.ATTRIB_NAME):(strictFail(b,"Invalid attribute name"),b.state=S.ATTRIB)}continue;case S.ATTRIB_VALUE:if(is(whitespace,d))continue;is(quote,d)?(b.q=d,b.state=S.ATTRIB_VALUE_QUOTED):(strictFail(b,"Unquoted attribute value"),b.state=S.ATTRIB_VALUE_UNQUOTED,b.attribValue=d);continue;case S.ATTRIB_VALUE_QUOTED:if(d!==b.q){"&"===d?b.state=S.ATTRIB_VALUE_ENTITY_Q:b.attribValue+=d;continue}attrib(b),b.q="",b.state=S.ATTRIB_VALUE_CLOSED;continue;case S.ATTRIB_VALUE_CLOSED:is(whitespace,d)?b.state=S.ATTRIB:">"===d?openTag(b):"/"===d?b.state=S.OPEN_TAG_SLASH:is(nameStart,d)?(strictFail(b,"No whitespace between attributes"),b.attribName=d,b.attribValue="",b.state=S.ATTRIB_NAME):strictFail(b,"Invalid attribute name");continue;case S.ATTRIB_VALUE_UNQUOTED:if(not(attribEnd,d)){"&"===d?b.state=S.ATTRIB_VALUE_ENTITY_U:b.attribValue+=d;continue}attrib(b),">"===d?openTag(b):b.state=S.ATTRIB;continue;case S.CLOSE_TAG:if(b.tagName)">"===d?closeTag(b):is(nameBody,d)?b.tagName+=d:b.script?(b.script+="</"+b.tagName,b.tagName="",b.state=S.SCRIPT):(not(whitespace,d)&&strictFail(b,"Invalid tagname in closing tag"),b.state=S.CLOSE_TAG_SAW_WHITE);else{if(is(whitespace,d))continue;not(nameStart,d)?b.script?(b.script+="</"+d,b.state=S.SCRIPT):strictFail(b,"Invalid tagname in closing tag."):b.tagName=d}continue;case S.CLOSE_TAG_SAW_WHITE:if(is(whitespace,d))continue;">"===d?closeTag(b):strictFail(b,"Invalid characters in closing tag");continue;case S.TEXT_ENTITY:case S.ATTRIB_VALUE_ENTITY_Q:case S.ATTRIB_VALUE_ENTITY_U:var g,h;switch(b.state){case S.TEXT_ENTITY:g=S.TEXT,h="textNode";break;case S.ATTRIB_VALUE_ENTITY_Q:g=S.ATTRIB_VALUE_QUOTED,h="attribValue";break;case S.ATTRIB_VALUE_ENTITY_U:g=S.ATTRIB_VALUE_UNQUOTED,h="attribValue"}";"===d?(b[h]+=parseEntity(b),b.entity="",b.state=g):is(b.entity.length?entityBody:entityStart,d)?b.entity+=d:(strictFail(b,"Invalid character in entity name"),b[h]+="&"+b.entity+d,b.entity="",b.state=g);continue;default:throw new Error(b,"Unknown state: "+b.state)}}return b.position>=b.bufferCheckPosition&&checkBufferLength(b),b}var sax={};sax.parser=function(a,b){return new SAXParser(a,b)},sax.SAXParser=SAXParser,sax.SAXStream=SAXStream,sax.createStream=createStream,sax.MAX_BUFFER_LENGTH=65536;var buffers=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];sax.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(a){function b(){}b.prototype=a;var c=new b;return c}),Object.keys||(Object.keys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}),SAXParser.prototype={end:function(){end(this)},write:write,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){flushBuffers(this)}};var Stream;try{Stream=require("stream").Stream}catch(a){Stream=function(){}}var streamWraps=sax.EVENTS.filter(function(a){return"error"!==a&&"end"!==a});SAXStream.prototype=Object.create(Stream.prototype,{constructor:{value:SAXStream}}),SAXStream.prototype.write=function(a){if("function"==typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(a)){if(!this._decoder){var b=require("string_decoder").StringDecoder;this._decoder=new b("utf8")}a=this._decoder.write(a)}return this._parser.write(a.toString()),this.emit("data",a),!0},SAXStream.prototype.end=function(a){return a&&a.length&&this.write(a),this._parser.end(),!0},SAXStream.prototype.on=function(a,b){var c=this;return c._parser["on"+a]||streamWraps.indexOf(a)===-1||(c._parser["on"+a]=function(){var b=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);b.splice(0,0,a),c.emit.apply(c,b)}),Stream.prototype.on.call(c,a,b)};var whitespace="\r\n\t ",number="0124356789",letter="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",quote="'\"",attribEnd=whitespace+">",CDATA="[CDATA[",DOCTYPE="DOCTYPE",XML_NAMESPACE="http://www.w3.org/XML/1998/namespace",XMLNS_NAMESPACE="http://www.w3.org/2000/xmlns/",rootNS={xml:XML_NAMESPACE,xmlns:XMLNS_NAMESPACE};whitespace=charClass(whitespace),number=charClass(number),letter=charClass(letter);var nameStart=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,nameBody=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040\.\d-]/,entityStart=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,entityBody=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040\.\d-]/;quote=charClass(quote),attribEnd=charClass(attribEnd);var S=0;sax.STATE={BEGIN:S++,BEGIN_WHITESPACE:S++,TEXT:S++,TEXT_ENTITY:S++,OPEN_WAKA:S++,SGML_DECL:S++,SGML_DECL_QUOTED:S++,DOCTYPE:S++,DOCTYPE_QUOTED:S++,DOCTYPE_DTD:S++,DOCTYPE_DTD_QUOTED:S++,COMMENT_STARTING:S++,COMMENT:S++,COMMENT_ENDING:S++,COMMENT_ENDED:S++,CDATA:S++,CDATA_ENDING:S++,CDATA_ENDING_2:S++,PROC_INST:S++,PROC_INST_BODY:S++,PROC_INST_ENDING:S++,OPEN_TAG:S++,OPEN_TAG_SLASH:S++,ATTRIB:S++,ATTRIB_NAME:S++,ATTRIB_NAME_SAW_WHITE:S++,ATTRIB_VALUE:S++,ATTRIB_VALUE_QUOTED:S++,ATTRIB_VALUE_CLOSED:S++,ATTRIB_VALUE_UNQUOTED:S++,ATTRIB_VALUE_ENTITY_Q:S++,ATTRIB_VALUE_ENTITY_U:S++,CLOSE_TAG:S++,CLOSE_TAG_SAW_WHITE:S++,SCRIPT:S++,SCRIPT_ENDING:S++},sax.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},sax.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(sax.ENTITIES).forEach(function(a){var b=sax.ENTITIES[a],c="number"==typeof b?String.fromCharCode(b):b;sax.ENTITIES[a]=c});for(var s in sax.STATE)sax.STATE[sax.STATE[s]]=s;S=sax.STATE,String.fromCodePoint||!function(){var a=String.fromCharCode,b=Math.floor,c=function(){var e,f,c=16384,d=[],g=-1,h=arguments.length;if(!h)return"";for(var i="";++g<h;){var j=Number(arguments[g]);if(!isFinite(j)||j<0||j>1114111||b(j)!==j)throw RangeError("Invalid code point: "+j);j<=65535?d.push(j):(j-=65536,e=(j>>10)+55296,f=j%1024+56320,d.push(e,f)),(g+1===h||d.length>c)&&(i+=a.apply(null,d),d.length=0)}return i};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:c,configurable:!0,writable:!0}):String.fromCodePoint=c}(),function(){function a(a){var b=c[c.length-1].parser;this.name=a.name,this.attr=a.attributes,this.val="",this.isValCdata=!1,this.isValComment=!1,this.children=[],this.firstChild=null,this.lastChild=null,this.line=b.line,this.column=b.column,this.position=b.position,this.startTagPosition=b.startTagPosition}function b(a){if(a&&(a=a.toString().trim()),!a)throw new Error("No XML to parse!");this.doctype="",this.parser=sax.parser(!0),d(this.parser),c=[this],this.parser.write(a),delete this.parser}function d(a){a.onopentag=e,a.onclosetag=f,a.ontext=g,a.oncdata=h,a.oncomment=i,a.ondoctype=j,a.onerror=k}function e(){c[0]&&c[0]._opentag.apply(c[0],arguments)}function f(){c[0]&&c[0]._closetag.apply(c[0],arguments)}function g(){c[0]&&c[0]._text.apply(c[0],arguments)}function h(){c[0]&&c[0]._cdata.apply(c[0],arguments)}function i(){c[0]&&c[0]._comment.apply(c[0],arguments)}function j(){c[0]&&c[0]._doctype.apply(c[0],arguments)}function k(){c[0]&&c[0]._error.apply(c[0],arguments)}function l(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}function m(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}a.prototype._opentag=function(b){var d=new a(b);this.children.push(d),this.firstChild||(this.firstChild=d),this.lastChild=d,c.unshift(d)},a.prototype._closetag=function(){c.shift()},a.prototype._text=function(a){this.val=a},a.prototype._cdata=function(a){this.val=a,this.isValCdata=!0},a.prototype._comment=function(a){this.val=a,this.isValComment=!0},a.prototype._error=function(a){throw a},a.prototype.eachChild=function(a,b){for(var c=0,d=this.children.length;c<d;c++)if(a.call(b,this.children[c],c,this.children)===!1)return},a.prototype.childNamed=function(a){for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];if(d.name===a)return d}},a.prototype.childrenNamed=function(a){for(var b=[],c=0,d=this.children.length;c<d;c++)this.children[c].name===a&&b.push(this.children[c]);return b},a.prototype.childWithAttribute=function(a,b){for(var c=0,d=this.children.length;c<d;c++){var e=this.children[c];if(b&&e.attr[a]===b||!b&&e.attr[a])return e}},a.prototype.descendantWithPath=function(a){for(var b=this,c=a.split("."),d=0,e=c.length;d<e;d++){if(!b)return;b=b.childNamed(c[d])}return b},a.prototype.valueWithPath=function(a){var b=a.split("@"),c=this.descendantWithPath(b[0]);return c?b.length>1?c.attr[b[1]]:c.val:void 0},a.prototype.toString=function(a){return this.toStringWithIndent("",a)},a.prototype.toStringWithIndent=function(a,b){var c=a+"<"+this.name,d=b&&b.compressed?"":"\n",e=b&&b.preserveWhitespace;for(var f in this.attr)Object.prototype.hasOwnProperty.call(this.attr,f)&&(c+=" "+f+'="'+m(this.attr[f])+'"');var g="";if(g=this.isValCdata?"<![CDATA["+this.val+"]]>":m(e?this.val:this.val.trim()),b&&b.trimmed&&g.length>25&&(g=g.substring(0,25).trim()+"â€¦"),this.children.length){c+=">"+d;var h=a+(b&&b.compressed?"":"  ");g.length&&(c+=h+g+d);for(var i=0,j=this.children.length;i<j;i++)c+=this.children[i].toStringWithIndent(h,b)+d;c+=a+"</"+this.name+">"}else c+=g.length?">"+g+"</"+this.name+">":"/>";return c},l(b.prototype,a.prototype),b.prototype._opentag=function(b){"undefined"==typeof this.children?a.call(this,b):a.prototype._opentag.apply(this,arguments)},b.prototype._doctype=function(a){this.doctype+=a};var c=null;this.XmlDocument=b}();!function(){function a(a){return a.replace(/^\s+/g,"")}function b(a){return a.replace(/\s+$/g,"")}function c(c,d,e,f){function y(){function c(a){var b="",c=function(c){var d=b+c.toLowerCase();b=d.length<=a.length?d:d.substr(d.length-a.length,a.length)},d=function(){return b.indexOf(a)===-1};return{add:c,doesNotMatch:d}}return this.pos=0,this.token="",this.current_mode="CONTENT",this.tags={parent:"parent1",parentcount:1,parent1:""},this.tag_type="",this.token_text=this.last_token=this.last_text=this.token_type="",this.newlines=0,this.indent_content=h,this.indent_body_inner_html=i,this.indent_head_inner_html=j,this.Utils={whitespace:"\n\r\t ".split(""),single_token:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr","!doctype","?xml","?php","basefont","isindex"],extra_liners:w,in_array:function(a,b){for(var c=0;c<b.length;c++)if(a===b[c])return!0;return!1}},this.is_whitespace=function(a){for(var b=0;b<a.length;b++)if(!this.Utils.in_array(a.charAt(b),this.Utils.whitespace))return!1;return!0},this.traverse_whitespace=function(){var a="";if(a=this.input.charAt(this.pos),this.Utils.in_array(a,this.Utils.whitespace)){for(this.newlines=0;this.Utils.in_array(a,this.Utils.whitespace);)p&&"\n"===a&&this.newlines<=q&&(this.newlines+=1),this.pos++,a=this.input.charAt(this.pos);return!0}return!1},this.space_or_wrap=function(a){return this.line_char_count>=this.wrap_line_length?(this.print_newline(!1,a),this.print_indentation(a),!0):(this.line_char_count++,a.push(" "),!1)},this.get_content=function(){for(var a="",b=[];"<"!==this.input.charAt(this.pos);){if(this.pos>=this.input.length)return b.length?b.join(""):["","TK_EOF"];if(this.traverse_whitespace())this.space_or_wrap(b);else{if(r){var c=this.input.substr(this.pos,3);if("{{#"===c||"{{/"===c)break;if("{{!"===c)return[this.get_tag(),"TK_TAG_HANDLEBARS_COMMENT"];if("{{"===this.input.substr(this.pos,2)&&"{{else}}"===this.get_tag(!0))break}a=this.input.charAt(this.pos),this.pos++,this.line_char_count++,b.push(a)}}return b.length?b.join(""):""},this.get_contents_to=function(a){if(this.pos===this.input.length)return["","TK_EOF"];var b="",c=new RegExp("</"+a+"\\s*>","igm");c.lastIndex=this.pos;var d=c.exec(this.input),e=d?d.index:this.input.length;return this.pos<e&&(b=this.input.substring(this.pos,e),this.pos=e),b},this.record_tag=function(a){this.tags[a+"count"]?(this.tags[a+"count"]++,this.tags[a+this.tags[a+"count"]]=this.indent_level):(this.tags[a+"count"]=1,this.tags[a+this.tags[a+"count"]]=this.indent_level),this.tags[a+this.tags[a+"count"]+"parent"]=this.tags.parent,this.tags.parent=a+this.tags[a+"count"]},this.retrieve_tag=function(a){if(this.tags[a+"count"]){for(var b=this.tags.parent;b&&a+this.tags[a+"count"]!==b;)b=this.tags[b+"parent"];b&&(this.indent_level=this.tags[a+this.tags[a+"count"]],this.tags.parent=this.tags[b+"parent"]),delete this.tags[a+this.tags[a+"count"]+"parent"],delete this.tags[a+this.tags[a+"count"]],1===this.tags[a+"count"]?delete this.tags[a+"count"]:this.tags[a+"count"]--}},this.indent_to_tag=function(a){if(this.tags[a+"count"]){for(var b=this.tags.parent;b&&a+this.tags[a+"count"]!==b;)b=this.tags[b+"parent"];b&&(this.indent_level=this.tags[a+this.tags[a+"count"]])}},this.get_tag=function(a){var g,h,i,b="",c=[],d="",e=!1,f=!0,j=this.pos,k=this.line_char_count;a=void 0!==a&&a;do{if(this.pos>=this.input.length)return a&&(this.pos=j,this.line_char_count=k),c.length?c.join(""):["","TK_EOF"];if(b=this.input.charAt(this.pos),this.pos++,this.Utils.in_array(b,this.Utils.whitespace))e=!0;else{if("'"!==b&&'"'!==b||(b+=this.get_unformatted(b),e=!0),"="===b&&(e=!1),c.length&&"="!==c[c.length-1]&&">"!==b&&e){var m=this.space_or_wrap(c),n=m&&"/"!==b&&!u;if(e=!1,!f&&u&&"/"!==b&&(this.print_newline(!1,c),this.print_indentation(c),n=!0),n){var p=t;"force-aligned"===s&&(p=c.indexOf(" ")+1);for(var q=0;q<p;q++)c.push(l)}for(var v=0;v<c.length;v++)if(" "===c[v]){f=!1;break}}if(r&&"<"===i&&b+this.input.charAt(this.pos)==="{{"&&(b+=this.get_unformatted("}}"),c.length&&" "!==c[c.length-1]&&"<"!==c[c.length-1]&&(b=" "+b),e=!0),"<"!==b||i||(g=this.pos-1,i="<"),r&&!i&&c.length>=2&&"{"===c[c.length-1]&&"{"===c[c.length-2]&&(g="#"===b||"/"===b||"!"===b?this.pos-3:this.pos-2,i="{"),this.line_char_count++,c.push(b),c[1]&&("!"===c[1]||"?"===c[1]||"%"===c[1])){c=[this.get_comment(g)];break}if(r&&c[1]&&"{"===c[1]&&c[2]&&"!"===c[2]){c=[this.get_comment(g)];break}if(r&&"{"===i&&c.length>2&&"}"===c[c.length-2]&&"}"===c[c.length-1])break}}while(">"!==b);var x,y,w=c.join("");x=w.indexOf(" ")!==-1?w.indexOf(" "):"{"===w.charAt(0)?w.indexOf("}"):w.indexOf(">"),y="<"!==w.charAt(0)&&r?"#"===w.charAt(2)?3:2:1;var z=w.substring(y,x).toLowerCase();return"/"===w.charAt(w.length-2)||this.Utils.in_array(z,this.Utils.single_token)?a||(this.tag_type="SINGLE"):r&&"{"===w.charAt(0)&&"else"===z?a||(this.indent_to_tag("if"),this.tag_type="HANDLEBARS_ELSE",this.indent_content=!0,this.traverse_whitespace()):this.is_unformatted(z,o)?(d=this.get_unformatted("</"+z+">",w),c.push(d),h=this.pos-1,this.tag_type="SINGLE"):"script"===z&&(w.search("type")===-1||w.search("type")>-1&&w.search(/\b(text|application|dojo)\/(x-)?(javascript|ecmascript|jscript|livescript|(ld\+)?json|method|aspect)/)>-1)?a||(this.record_tag(z),this.tag_type="SCRIPT"):"style"===z&&(w.search("type")===-1||w.search("type")>-1&&w.search("text/css")>-1)?a||(this.record_tag(z),this.tag_type="STYLE"):"!"===z.charAt(0)?a||(this.tag_type="SINGLE",this.traverse_whitespace()):a||("/"===z.charAt(0)?(this.retrieve_tag(z.substring(1)),this.tag_type="END"):(this.record_tag(z),"html"!==z.toLowerCase()&&(this.indent_content=!0),this.tag_type="START"),this.traverse_whitespace()&&this.space_or_wrap(c),this.Utils.in_array(z,this.Utils.extra_liners)&&(this.print_newline(!1,this.output),this.output.length&&"\n"!==this.output[this.output.length-2]&&this.print_newline(!0,this.output))),a&&(this.pos=j,this.line_char_count=k),c.join("")},this.get_comment=function(a){var b="",c=">",d=!1;this.pos=a;var e=this.input.charAt(this.pos);for(this.pos++;this.pos<=this.input.length&&(b+=e,b.charAt(b.length-1)!==c.charAt(c.length-1)||b.indexOf(c)===-1);)!d&&b.length<10&&(0===b.indexOf("<![if")?(c="<![endif]>",d=!0):0===b.indexOf("<![cdata[")?(c="]]>",d=!0):0===b.indexOf("<![")?(c="]>",d=!0):0===b.indexOf("<!--")?(c="-->",d=!0):0===b.indexOf("{{!--")?(c="--}}",d=!0):0===b.indexOf("{{!")?5===b.length&&b.indexOf("{{!--")===-1&&(c="}}",d=!0):0===b.indexOf("<?")?(c="?>",d=!0):0===b.indexOf("<%")&&(c="%>",d=!0)),e=this.input.charAt(this.pos),this.pos++;return b},this.get_unformatted=function(a,b){if(b&&b.toLowerCase().indexOf(a)!==-1)return"";var d="",e="",f=!0,g=c(a);do{if(this.pos>=this.input.length)return e;if(d=this.input.charAt(this.pos),this.pos++,this.Utils.in_array(d,this.Utils.whitespace)){if(!f){this.line_char_count--;continue}if("\n"===d||"\r"===d){e+="\n",this.line_char_count=0;continue}}e+=d,g.add(d),this.line_char_count++,f=!0,r&&"{"===d&&e.length&&"{"===e.charAt(e.length-2)&&(e+=this.get_unformatted("}}"))}while(g.doesNotMatch());return e},this.get_token=function(){var a;if("TK_TAG_SCRIPT"===this.last_token||"TK_TAG_STYLE"===this.last_token){var b=this.last_token.substr(7);return a=this.get_contents_to(b),"string"!=typeof a?a:[a,"TK_"+b]}if("CONTENT"===this.current_mode)return a=this.get_content(),"string"!=typeof a?a:[a,"TK_CONTENT"];if("TAG"===this.current_mode){if(a=this.get_tag(),"string"!=typeof a)return a;var c="TK_TAG_"+this.tag_type;return[a,c]}},this.get_full_indent=function(a){return a=this.indent_level+a||0,a<1?"":Array(a+1).join(this.indent_string)},this.is_unformatted=function(a,b){if(!this.Utils.in_array(a,b))return!1;if("a"!==a.toLowerCase()||!this.Utils.in_array("a",b))return!0;var c=this.get_tag(!0),d=(c||"").match(/^\s*<\s*\/?([a-z]*)\s*[^>]*>\s*$/);return!(d&&!this.Utils.in_array(d,b))},this.printer=function(c,d,e,f,g){this.input=c||"",this.input=this.input.replace(/\r\n|[\r\u2028\u2029]/g,"\n"),this.output=[],this.indent_character=d,this.indent_string="",this.indent_size=e,this.brace_style=g,this.indent_level=0,this.wrap_line_length=f,this.line_char_count=0;for(var h=0;h<this.indent_size;h++)this.indent_string+=this.indent_character;this.print_newline=function(a,c){this.line_char_count=0,c&&c.length&&(a||"\n"!==c[c.length-1])&&("\n"!==c[c.length-1]&&(c[c.length-1]=b(c[c.length-1])),c.push("\n"))},this.print_indentation=function(a){for(var b=0;b<this.indent_level;b++)a.push(this.indent_string),this.line_char_count+=this.indent_string.length},this.print_token=function(b){this.is_whitespace(b)&&!this.output.length||((b||""!==b)&&this.output.length&&"\n"===this.output[this.output.length-1]&&(this.print_indentation(this.output),b=a(b)),this.print_token_raw(b))},this.print_token_raw=function(a){this.newlines>0&&(a=b(a)),a&&""!==a&&(a.length>1&&"\n"===a.charAt(a.length-1)?(this.output.push(a.slice(0,-1)),this.print_newline(!1,this.output)):this.output.push(a));for(var c=0;c<this.newlines;c++)this.print_newline(c>0,this.output);this.newlines=0},this.indent=function(){this.indent_level++},this.unindent=function(){this.indent_level>0&&this.indent_level--}},this}var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(d=d||{},void 0!==d.wrap_line_length&&0!==parseInt(d.wrap_line_length,10)||void 0===d.max_char||0===parseInt(d.max_char,10)||(d.wrap_line_length=d.max_char),h=void 0!==d.indent_inner_html&&d.indent_inner_html,i=void 0===d.indent_body_inner_html||d.indent_body_inner_html,j=void 0===d.indent_head_inner_html||d.indent_head_inner_html,k=void 0===d.indent_size?4:parseInt(d.indent_size,10),l=void 0===d.indent_char?" ":d.indent_char,n=void 0===d.brace_style?"collapse":d.brace_style,m=0===parseInt(d.wrap_line_length,10)?32786:parseInt(d.wrap_line_length||250,10),o=d.unformatted||["a","abbr","area","audio","b","bdi","bdo","br","button","canvas","cite","code","data","datalist","del","dfn","em","embed","i","iframe","img","input","ins","kbd","keygen","label","map","mark","math","meter","noscript","object","output","progress","q","ruby","s","samp","select","small","span","strong","sub","sup","svg","template","textarea","time","u","var","video","wbr","text","acronym","address","big","dt","ins","small","strike","tt","pre"],p=void 0===d.preserve_newlines||d.preserve_newlines,q=p?isNaN(parseInt(d.max_preserve_newlines,10))?32786:parseInt(d.max_preserve_newlines,10):0,r=void 0!==d.indent_handlebars&&d.indent_handlebars,s=void 0===d.wrap_attributes?"auto":d.wrap_attributes,t=isNaN(parseInt(d.wrap_attributes_indent_size,10))?k:parseInt(d.wrap_attributes_indent_size,10),u="force"===s.substr(0,"force".length),v=void 0!==d.end_with_newline&&d.end_with_newline,w="object"==typeof d.extra_liners&&d.extra_liners?d.extra_liners.concat():"string"==typeof d.extra_liners?d.extra_liners.split(","):"head,body,/html".split(","),x=d.eol?d.eol:"\n",d.indent_with_tabs&&(l="\t",k=1),x=x.replace(/\\r/,"\r").replace(/\\n/,"\n"),g=new y,g.printer(c,l,k,m,n);;){var z=g.get_token();if(g.token_text=z[0],g.token_type=z[1],"TK_EOF"===g.token_type)break;switch(g.token_type){case"TK_TAG_START":g.print_newline(!1,g.output),g.print_token(g.token_text),g.indent_content&&(!g.indent_body_inner_html&&g.token_text.match(/<body(?:.*)>/)||!g.indent_head_inner_html&&g.token_text.match(/<head(?:.*)>/)||g.indent(),g.indent_content=!1),g.current_mode="CONTENT";break;case"TK_TAG_STYLE":case"TK_TAG_SCRIPT":g.print_newline(!1,g.output),g.print_token(g.token_text),g.current_mode="CONTENT";break;case"TK_TAG_END":if("TK_CONTENT"===g.last_token&&""===g.last_text){var A=(g.token_text.match(/\w+/)||[])[0],B=null;g.output.length&&(B=g.output[g.output.length-1].match(/(?:<|{{#)\s*(\w+)/)),(null===B||B[1]!==A&&!g.Utils.in_array(B[1],o))&&g.print_newline(!1,g.output)}g.print_token(g.token_text),g.current_mode="CONTENT";break;case"TK_TAG_SINGLE":var C=g.token_text.match(/^\s*<([a-z-]+)/i);C&&g.Utils.in_array(C[1],o)||g.print_newline(!1,g.output),g.print_token(g.token_text),g.current_mode="CONTENT";break;case"TK_TAG_HANDLEBARS_ELSE":for(var D=!1,E=g.output.length-1;E>=0&&"\n"!==g.output[E];E--)if(g.output[E].match(/{{#if/)){D=!0;break}D||g.print_newline(!1,g.output),g.print_token(g.token_text),g.indent_content&&(g.indent(),g.indent_content=!1),g.current_mode="CONTENT";break;case"TK_TAG_HANDLEBARS_COMMENT":g.print_token(g.token_text),g.current_mode="TAG";break;case"TK_CONTENT":g.print_token(g.token_text),g.current_mode="TAG";break;case"TK_STYLE":case"TK_SCRIPT":if(""!==g.token_text){g.print_newline(!1,g.output);var G,F=g.token_text,H=1;"TK_SCRIPT"===g.token_type?G="function"==typeof e&&e:"TK_STYLE"===g.token_type&&(G="function"==typeof f&&f),"keep"===d.indent_scripts?H=0:"separate"===d.indent_scripts&&(H=-g.indent_level);var I=g.get_full_indent(H);if(G){var J=function(){this.eol="\n"};J.prototype=d;var K=new J;F=G(F.replace(/^\s*/,I),K)}else{var L=F.match(/^\s*/)[0],M=L.match(/[^\n\r]*$/)[0].split(g.indent_string).length-1,N=g.get_full_indent(H-M);F=F.replace(/^\s*/,I).replace(/\r\n|\r|\n/g,"\n"+N).replace(/\s+$/,"")}F&&(g.print_token_raw(F),g.print_newline(!0,g.output))}g.current_mode="TAG";break;default:""!==g.token_text&&g.print_token(g.token_text)}g.last_token=g.token_type,g.last_text=g.token_text}var O=g.output.join("").replace(/[\r\n\t ]+$/,"");return v&&(O+="\n"),"\n"!==x&&(O=O.replace(/[\n]/g,x)),O}this.html_beautify=function(a,b){return c(a,b,this.js_beautify,this.css_beautify)}}();


// node packages
var fs = require('fs');

// define the way to parse html files
require.extensions['.html'] = function(module, filename) {
    module.exports = fs.readFileSync(filename, 'utf8');
};

// define the way to parse ubml files
require.extensions['.ubml'] = function(module, filename) {
    module.exports = fs.readFileSync(filename, 'utf8');
};

// storing all block snippets from the blocks/ directory
var blocks = {};
try {
    fs.readdirSync('blocks/').forEach(function(name) {
        if (name.match(/\.html$/g)) {
            blocks[name.slice(0,-5)] = require('./blocks/'+ name);
        }
    });
} catch (e) { /* ~~ Won't break anything ~~ */ }

// making sure the build folder exists
if (!fs.existsSync('build/')) {
    fs.mkdirSync('build');
}

var tt = `
<ubml>
    <en table="asfsd" item="asdasd">
        <box bgcolor="asfsd2" padding="asdasd2">
            <border>
                <box>
                    <img src="" />
                </box>
                <box>
                    <img src="" />
                </box>
            </border>
            <border>
                <box>
                    <img src="" />
                </box>
                <box>
                    <img src="" />
                </box>
            </border>
        </box>
    </en>
    <en table="asfsd" item="asdasd">
        <box bgcolor="asfsd2" padding="asdasd2">
            <border>
                <box>
                    <img src="" />
                </box>
                <box>
                    <img src="" />
                </box>
            </border>
            <border>
                <box>
                    <img src="" />
                </box>
                <box>
                    <img src="" />
                </box>
            </border>
        </box>
    </en>
</ubml>
`

var template = new XmlDocument(tt);

if (template.name !== 'ubml') {
    console.log('please wrap your code in <ubml> ... </ubml> tags.');
    process.exit();
}

template.children.forEach(parent => {
    var name = parent.name;
    var compiled = read(parent.children);
    //console.log(tt);
    console.log(html_beautify(compiled));
});

function read(doc) {
    var compiled = '';
    doc.forEach(parent => {
        var tag = parent.name;
        var xml_attr = JSON.stringify(parent.attr).replace(/"(\w+)":"(\w+)",?/g, (match, key, value) => {
            return key + '="' + value + '" '
        }).slice(1,-1);
        if (!blocks[tag]) {
            compiled += `<${tag} ${xml_attr}>${read(parent.children)}</${tag}>`;
        }
        compiled += blocks[tag].replace(/@@\.(\w+)(?:\.{(.+)})?@/g, (match, key, def) => {
            return parent.attr[key] || def || ' ';
        }).replace(/@@content@/g, read(parent.children));
    });
    return compiled;
}